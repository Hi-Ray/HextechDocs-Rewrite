name: Hextech Docs Rewrite
type: docker
kind: pipeline

steps:

  - name: build
    image: node
    commands:
      - yarn
      - yarn prebuild
      - yarn build

  - name: discord notification
    pull: always
    image: appleboy/drone-discord
    settings:
      message: "{{#success build.status}} \n
      âœ…  Build #{{build.number}} of `{{repo.name}}/{{repo.owner}}` succeeded.\n\n
      ğŸ“ Commit: {{build.commit}} by {{commit.author}} on `{{commit.branch}}`:\n
      ``` {{commit.message}} ```\n
      ğŸŒ {{ build.link }}\n\n
      âœ… duration: {{duration since build.started}} \n\n
      âœ… started: {{datetime build.started \"02/01/2006 15:04\" \"Europe/London\"}} \n\n
      âœ… finished: {{datetime build.finished \"02/01/2006 15:04\" \"Europe/London\"}}
      {{else}}
      \n
      âŒ  Build #{{build.number}} of `{{repo.name}}/{{repo.owner}}` failed.\n\n
      ğŸ“ Commit: {{build.commit}} by {{commit.author}} on `{{commit.branch}}`:\n
      ``` {{commit.message}} ```\nğŸŒ {{ build.link }}\n\n
      âœ… duration: {{duration since build.started}} \n\n
      âœ… started: {{datetime build.started \"02/01/2006 15:04\" \"Europe/London\"}} \n\n
      âœ… finished: {{datetime build.finished \"02/01/2006 15:04\" \"Europe/London\"}}{{/success}}\n"
      webhook_id:
        from_secret: webhook_id
      webhook_token:
        from_secret: webhook_token
    when:
      status: [ failure, changed, success ]

  - name: email results
    image: drillster/drone-email
    host:
      from_secret: email_host
    username:
      from_secret: email_user
    password:
      from_secret: email_pass
    from: build@hextechdocs.dev
    skip_verify: true
    recipients: [ dev@hiray.me ]
    when:
      status: [ failure, changed, success ]

  - name: upload artifacts
    image: cschlosser/drone-ftps
    hostname:
      from_secret: ftp_host
    secrets: [ ftp_username, ftp_password ]
    secure: true
    clean_dir: true
    dest_dir:
      from_secret: ftp_dest
    when:
      status: [ success ]
